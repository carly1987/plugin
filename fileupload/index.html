<!DOCTYPE html>
<!--[if IE 8]> <html lang="zh-cn" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]> <html lang="zh-cn" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="zh-cn" class="no-js">
<!--<![endif]-->
<!-- BEGIN HEAD -->
<head>
    <meta charset="utf-8"/>
    <title>上传组件</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, width=device-width">
    <meta content="" name="description"/>
    <meta content="" name="author"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/bootstrap.css">
    <link type="text/css" rel="stylesheet" href="../assets/font/font-awesome.min.css">
    <style>
        .cieldon-file {
            float: left;
            width: 100%;
            overflow: visible;
        }

        .file-btn {
            position: relative;
            float: left;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .file-img {
            width: 110px;
            height: 110px;
            margin: 0 20px 20px 0;
            float: left;
            overflow: visible;
            position: relative;
        }

        .file-img a {
            background-color: #ddd;
            background-size: 100% 100%;
            background-repeat: no-repeat;
            color: #f1f1f1;
            display: table;
            width: 100%;
            height: 100%;
            text-align: center;
            overflow: hidden;
        }

        .file-btn a > * {
            display: table-cell;
            width: 100%;
            height: 100%;
            overflow: hidden;
            vertical-align: middle;
        }

        .file-btn a > * > * {
            display: block;
        }

        .file-btn a > * > .fa {
            font-size: 30px;
            line-height: 40px;
        }

        .file-btn input[type="file"] {
            width: 200%;
            height: 200%;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            filter: alpha(opacity=0);
            -moz-opacity: 0;
            -khtml-opacity: 0;
        }

        .file-img .file-del {
            top: -5px;
            right: -5px;
            color: #fff;
            font-size: 14px;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-radius: 10000px;
            background: #999;
            position: absolute;
            cursor: pointer;
        }

        .file-img .file-del:hover {
            background: #ccc;
        }
        .file-list{float: left; width: 100%; margin-left: -10px;}
        .file-list>*{margin: 10px 0 10px 10px;}
        .cieldon-progress {
            position: absolute;
            bottom: 10px;
            width: 80%;
            border-radius: 1000px;
            background: #ddd;
            overflow: hidden;
            left: 10%;
            height: 6px;
        }

        .cieldon-progress > * {
            display: block;
            width: 0%;
            height: 100%;
            border-radius: 1000px;
            background: #6fb3e0;
        }
    </style>
</head>
<body style="padding: 20px;">
<h3>图片上传</h3>
<br/>
<p>1、自身更新</p>
<div class="cieldon-file" data-width="400" data-height="100" data-type="0"></div>
<br/>
<br/>
<p>2、指定div添加</p>
<div class="cieldon-file" data-type="1" data-div="#img-1" data-height="100"></div>
<div id="img-1" style="background-color:#ddd;overflow: hidden;"></div>
<br/>
<br/>
<p>3、向右添加</p>
<div class="cieldon-file" data-type="2"></div>
<br/>
<br/>
<p>4、向下添加</p>
<div class="cieldon-file" data-type="3"></div>
<script src="../assets/js/lib/jquery.js"></script>
<script src="../assets/js/lib/bootstrap.min.js"></script>
<script>
    ;(function($,win,doc){
        "use strict";
        $.cieldonfileupload=function(el, options){
            var self=this,
                o,
                t;
            self.el=el;
            self.$el=$(el);
            self.$el.data("CieldonFileuoload",self);
            self.input=self.$el.find("input[type=file]");
            self.init=function(){
                self.options = o = $.extend({}, $.cieldonfileupload.defaults, options);
                self.width=self.$el.attr("data-width") || o.width;
                self.height=self.$el.attr("data-height") || o.height;
                self.type=self.$el.attr("data-type") || o.type;
                self.target=self.$el.attr("data-div")
                switch (self.type){
                    case "0":
                        self.$el.html('<div class="file-img" style="width: '+self.width+'px; height: '+self.height+'px;"><div class="file-btn"><a style="width: '+self.width+'px; height: '+self.height+'px;"><p><i class="fa fa-plus"></i><small>上传图片</small></p></a><input type="file" value="上传图片" data-token="'+ o.token+'" data-bucket="'+o.bucket+'"></div></div>');
                        break;
                    case "1":
                        self.$el.html('<div class="file-btn"><a class="btn btn-info">上传图片</a><input type="file" value="上传图片" data-div="'+self.target+'" data-token="'+ o.token+'" data-bucket="'+o.bucket+'" data-width="'+self.width+'" data-height="'+self.height+'"></div>');
                        break;
                    case "2":
                        self.$el.html('<div class="file-img" style="width: '+self.width+'px; height: '+self.height+'px;"><div class="file-btn"><a><p><i class="fa fa-plus"></i><small>上传图片</small></p></a><input type="file" value="上传图片" data-token="'+ o.token+'" data-bucket="'+o.bucket+'"></div></div>');
                        break;
                    case "3":
                        self.$el.html('<div class="file-btn"><a class="btn btn-info">上传图片</a><input type="file" value="上传图片" data-div="'+self.target+'" data-token="'+ o.token+'" data-bucket="'+o.bucket+'" data-width="'+self.width+'" data-height="'+self.height+'"/></div><div class="file-list"></div>');
                        break;
                    default :
                        break;
                };
                self.$el.on("change",self.input,function(){
                    var input=$(this).find("input[type=file]")[0];
                    if (input.type === 'file' && input.files && input.files.length > 0) {
                        $.each(input.files, function (idx, fileInfo) {
                            if (/^image\//.test(fileInfo.type)) {

                                self.getImgUrl(input,input.files,self.type,fileInfo);
                                //$(input).prev().css({"background-image":"url("+img+")"});
//                                $.when(self.readFileIntoDataUrl(fileInfo)).done(function (dataUrl) {
//                                    $(input).prev().css({"background-image":"url("+dataUrl+")"});
//                                }).fail(function (e) {
//                                    options.fileUploadError("file-reader", e);
//                                });
                            } else {
                                options.fileUploadError("unsupported-file-type", fileInfo.type);
                            }
                        });
                    }
                });
            };
            self.init();
            self.readFileIntoDataUrl=function(fileInfo){
                var loader = $.Deferred(),
                        fReader = new FileReader();
                fReader.onload = function (e) {
                    loader.resolve(e.target.result);
                };
                fReader.onerror = loader.reject;
                fReader.onprogress = loader.notify;
                fReader.readAsDataURL(fileInfo);
                return loader.promise();
            };
            self.getImgUrl=function(input,r,type,fileInfo){
                var token= o.token;
                var bucket= o.bucket;
                var Qiniu_UploadUrl = "http://up.qiniu.com";
                var Qiniu_upload = function(f, token) {
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', Qiniu_UploadUrl, true);
                    var formData, startDate;
                    formData = new FormData();
                    formData.append('token', token);
                    formData.append('file', f);
                    xhr.onreadystatechange = function(response) {
                        if (xhr.readyState == 4 && xhr.status == 200 && xhr.responseText != "") {
                            var blkRet = JSON.parse(xhr.responseText);
                            var imgUrl='http://'+bucket+'.qiniudn.com/'+blkRet.key;
                            self.renderImg(input,imgUrl,type);
                        } else if (xhr.status != 200 && xhr.responseText) {

                        }
                    };
                    startDate = new Date().getTime();
                    xhr.send(formData);
                };
                if (r.length > 0 && token != "") {
                    Qiniu_upload(r[0], token);
                } else {
                    $.when(self.readFileIntoDataUrl(fileInfo)).done(function (dataUrl) {
                        self.renderImg(input,dataUrl,type);
                    }).fail(function (e) {
                        console.log("出错了");
                    });
                }

            };
            self.renderImg=function(input,img,type){
                switch (type){
                    case "0":
                        var a=$(input).prev();
                        a.css({"background-image":"url("+img+")"});
                        a.find("p").html("");
                        break;
                    case "1":
                        var w=$(input).attr("data-width") || "100%",
                            h=$(input).attr("data-height") || "100%";
                        console.log(w);
                        $(self.target).css({"background-image":"url("+img+")","background-size": "100% 100%","background-repeat": "no-repeat","width":w,height:h});
                        break;
                    case "2":
                        var fileImg=$(input).parents(".file-img"),
                            w=fileImg.innerWidth(),
                            h=fileImg.innerHeight(),
                            html='<div class="file-img" style="width:'+w+'px; height: '+h+'px;"><div class="file-btn"><a style="background-image: url('+img+')"></a><input type="file" value="上传图片"></div><i class="fa fa-times file-del"></i></div>';
                        fileImg.after(html);
                        break;
                    case "3":
                        var fileList=$(input).parents(".file-btn").next(".file-list"),
                            w=$(input).attr("data-width"),
                            h=$(input).attr("data-height"),
                            html='<div class="file-img" style="width:'+w+'px; height: '+h+'px;"><div class="file-btn"><a style="background-image: url('+img+')"></a><input type="file" value="上传图片"></div><i class="fa fa-times file-del"></i></div>';
                        fileList.prepend(html);
                        break;
                    default :
                        break;
                }
            }
        };
        $.cieldonfileupload.defaults={
            width:"",
            height:"",
            type:"",
            token:"",
            bucket:""
        };
        $.fn.cieldonfileupload=function(options,callback){
            return this.each(function(){
                var cdfileupload = $(this).data('CieldonFileuoload');
                if ((typeof(options)).match('object|undefined')){
                    if (!cdfileupload) {
                        (new $.cieldonfileupload(this, options));
                    }
                }
            });
        };
    })(jQuery, window, document);
</script>
<script>
    function getTokenBucket(url){
        var r=$.ajax({
            type: "Get",
            url: url,
            async:false,
            context: document.body,
            success: function(data){}
        });
        r=$.parseJSON(r.responseText);
        r=[r.data.BUCKET,r.data.token];
        return r;
    }
    $(function(){
//        var tb=getTokenBucket("http://notes18.com/notes/15/entries/443.json?ownership_token=4317af51-dfc6-470f-87b7-56fb38cb2eec"),
//            token=tb[1],
//            bucket=tb[0];
        var token="",
            bucket="";
        $(".cieldon-file").cieldonfileupload({
            token:token,
            bucket:bucket
        });
    });
</script>
</body>
</html>